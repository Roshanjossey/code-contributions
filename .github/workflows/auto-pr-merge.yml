name: Auto-merge PRs
on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - "contributors/**" # Run if only contributors dir changed

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 2

      - name: Get a list of files changed in the pull request
        run: |
          PR_FILES=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            --jq '.[].filename')
          FILES_CHANGED=$(echo $PR_FILES | tr '\n' ' ')
          echo "FILES_CHANGED=$FILES_CHANGED" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if PR modifies only contributors/{username}.html
        id: only_contributors_check
        uses: actions/github-script@v6
        with:
          script: |
            const username = context.payload.pull_request.user.login;
            const expected = `contributors/${username}.html`;
            const filesChanged = process.env.FILES_CHANGED.trim();
            console.log(`Comparing "${filesChanged}" to "${expected}"`);
            const onlyContributors = filesChanged === expected;
            core.setOutput('only_contributors', onlyContributors);

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install bs4 groq

      - name: Check PR contents
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python scripts/check_pr.py

      - name: Auto-approve PR if not flagged
        if: success() && steps.only_contributors_check.outputs.only_contributors == 'true'
        run: gh pr merge --merge "${{ github.event.pull_request.html_url }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create comment if not flagged
        if: success() && steps.only_contributors_check.outputs.only_contributors == 'true'
        run: echo "üëè You've successfully submitted a PR, and it's been automatically merged!" | tee comment.txt

      - name: Create comment if flagged
        if: failure()
        run: echo "üö© Your PR was flagged. Please review and appropriately modify your PR; if this flag is in error, wait for the maintainer to review it." | tee comment.txt

      - name: Create comment if something other than contributors/{username}.html was modified
        if: success() && steps.only_contributors_check.outputs.only_contributors != 'true'
        run: echo "üëè You've successfully submitted a PR! It contains changes that require review by the maintainer before merging.\nFiles changed:\n$FILES_CHANGED" | tee comment.txt

      - name: Post comment on PR
        if: always()
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: comment.txt
